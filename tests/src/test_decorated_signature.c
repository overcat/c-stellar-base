#include <setjmp.h>
#include <stdarg.h>
#include <stddef.h>

#include "../../src/decorated_signature.h"
#include <cmocka.h>

void test_signature_to_xdr_object(void **state) {
  struct DecoratedSignature in = {
      .signatureHint =
          {
              0x3b,
              0x97,
              0x74,
              0xcd,
          },
      .signature = {
          0x7f, 0xff, 0xb1, 0x32, 0x3a, 0xff, 0x7,  0x57, 0x3b, 0x97, 0x74,
          0xcd, 0x32, 0x2e, 0x74, 0x46, 0xa5, 0xc9, 0x30, 0x5f, 0x99, 0x49,
          0x6,  0xbd, 0xfc, 0x74, 0xdb, 0x7d, 0x6e, 0x1d, 0x9d, 0x12, 0x3b,
          0x97, 0x74, 0xcd, 0x32, 0x2e, 0x74, 0x46, 0xa5, 0xc9, 0x30, 0x5f,
          0x99, 0x49, 0x6,  0xbd, 0xfc, 0x74, 0xdb, 0x7d, 0x6e, 0x1d, 0x9d,
          0x12, 0x7f, 0xff, 0xb1, 0x32, 0x3a, 0xff, 0x7,  0x57,
      }};
  stellarxdr_DecoratedSignature out;
  assert_true(decorated_signature_to_xdr_object(&in, &out));
  assert_memory_equal(in.signatureHint, out.hint, 4);
  assert_memory_equal(in.signature, out.signature.stellarxdr_Signature_val, 64);
}

void test_signature_from_xdr_object(void **state) {
  char signature[] = {
      0x7f, 0xff, 0xb1, 0x32, 0x3a, 0xff, 0x7,  0x57, 0x3b, 0x97, 0x74,
      0xcd, 0x32, 0x2e, 0x74, 0x46, 0xa5, 0xc9, 0x30, 0x5f, 0x99, 0x49,
      0x6,  0xbd, 0xfc, 0x74, 0xdb, 0x7d, 0x6e, 0x1d, 0x9d, 0x12, 0x3b,
      0x97, 0x74, 0xcd, 0x32, 0x2e, 0x74, 0x46, 0xa5, 0xc9, 0x30, 0x5f,
      0x99, 0x49, 0x6,  0xbd, 0xfc, 0x74, 0xdb, 0x7d, 0x6e, 0x1d, 0x9d,
      0x12, 0x7f, 0xff, 0xb1, 0x32, 0x3a, 0xff, 0x7,  0x57,
  };
  stellarxdr_DecoratedSignature in = {
      .signature =
          {
              .stellarxdr_Signature_len = 64,
          },
      .hint =
          {
              0x3b,
              0x97,
              0x74,
              0xcd,
          },
  };
  in.signature.stellarxdr_Signature_val = malloc(64);
  memcpy(in.signature.stellarxdr_Signature_val, signature, 64);

  struct DecoratedSignature out;
  assert_true(decorated_signature_from_xdr_object(&in, &out));
  assert_memory_equal(in.hint, out.signatureHint, 4);
  assert_memory_equal(signature, out.signature, 64);
}

int main() {
  const struct CMUnitTest tests[] = {
      cmocka_unit_test(test_signature_to_xdr_object),
      cmocka_unit_test(test_signature_from_xdr_object),
  };
  return cmocka_run_group_tests(tests, NULL, NULL);
}
